<!DOCTYPE html><html class="default"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>typed-struct</title><meta name="description" content="Documentation for typed-struct"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script async src="assets/search.js" id="search-script"></script></head><body><script>document.body.classList.add(localStorage.getItem("tsd-theme") || "os")</script><header><div class="tsd-page-toolbar"><div class="container"><div class="table-wrap"><div class="table-cell" id="tsd-search" data-base="."><div class="field"><label for="tsd-search-field" class="tsd-widget search no-caption">Search</label><input type="text" id="tsd-search-field"/></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="index.html" class="title">typed-struct</a></div><div class="table-cell" id="tsd-widgets"><div id="tsd-filter"><a href="#" class="tsd-widget options no-caption" data-toggle="options">Options</a><div class="tsd-filter-group"><div class="tsd-select" id="tsd-filter-visibility"><span class="tsd-select-label">All</span><ul class="tsd-select-list"><li data-value="public">Public</li><li data-value="protected">Public/Protected</li><li data-value="private" class="selected">All</li></ul></div> <input type="checkbox" id="tsd-filter-inherited" checked/><label class="tsd-widget" for="tsd-filter-inherited">Inherited</label><input type="checkbox" id="tsd-filter-externals" checked/><label class="tsd-widget" for="tsd-filter-externals">Externals</label></div></div><a href="#" class="tsd-widget menu no-caption" data-toggle="menu">Menu</a></div></div></div></div><div class="tsd-page-title"><div class="container"><h1>typed-struct</h1></div></div></header><div class="container container-main"><div class="row"><div class="col-8 col-content"><div class="tsd-panel tsd-typography">
<a href="#typed-struct" id="typed-struct" style="color: inherit; text-decoration: none;">
  <h1>typed-struct</h1>
</a>
<p>A JavaScript utility library (written in TypeScript) for creating objects and classes that store
their properties in a buffer for serialization/deserialization
similar to structures in C.</p>
<p><a href="https://www.npmjs.com/package/typed-struct"><img src="https://img.shields.io/npm/v/typed-struct.svg" alt="NPM version"></a>
<a href="https://www.npmjs.com/package/typed-struct"><img src="https://img.shields.io/npm/dm/typed-struct.svg" alt="NPM version"></a>
<a href="https://codecov.io/gh/sarakusha/typed-struct"><img src="https://codecov.io/gh/sarakusha/typed-struct/branch/main/graph/badge.svg?token=6F26I7FO73" alt="codecov"></a>
<a href="https://circleci.com/gh/sarakusha/typed-struct"><img src="https://circleci.com/gh/sarakusha/typed-struct.svg?style=shield" alt="CircleCI"></a>
<a href="https://lgtm.com/projects/g/sarakusha/typed-struct/context:javascript"><img src="https://img.shields.io/lgtm/grade/javascript/g/sarakusha/typed-struct.svg?logo=lgtm&logoWidth=18" alt="Language grade: JavaScript"></a>
<a href="https://nodei.co/npm/typed-struct/"><img src="https://nodei.co/npm/typed-struct.png?downloads=true" alt="NPM"></a></p>

<a href="#getting-started" id="getting-started" style="color: inherit; text-decoration: none;">
  <h2>Getting started</h2>
</a>
<p>Using npm:</p>
<pre><code class="language-bash"><span class="hl-1">$ npm install --save typed-struct</span>
</code></pre>
<p>or yarn:</p>
<pre><code class="language-bash"><span class="hl-1">$ yarn add typed-struct</span>
</code></pre>

<a href="#features" id="features" style="color: inherit; text-decoration: none;">
  <h2>Features</h2>
</a>
<p>The following types are supported:</p>
<ul>
<li>Integer (1, 2, 4, 8 bytes)</li>
<li>Boolean (1, 2, 4 bytes)</li>
<li>Float (4 bytes)</li>
<li>Double (8 bytes)</li>
<li>Bit fields (1, 2, 4 bytes)</li>
<li>Binary-decoded decimal (1 byte)</li>
<li>Buffer</li>
<li>String (with <a href="https://github.com/ashtuchkin/iconv-lite">iconv-lite</a> encodings)  </li>
<li>Custom type (requires custom getter/setter)</li>
</ul>
<p>Fixed values, endianness, nested types and arrays are also supported.</p>
<p>The generated structures will be strongly typed,
which will provide better documentation and allow TypeScript
to validate that your code is working correctly.</p>

<a href="#api" id="api" style="color: inherit; text-decoration: none;">
  <h2><a href="https://sarakusha.github.io/typed-struct/">API</a></h2>
</a>

<a href="#examples" id="examples" style="color: inherit; text-decoration: none;">
  <h2>Examples</h2>
</a>

<a href="#create-a-data-structure-by-chaining-the-appropriate-method-calls" id="create-a-data-structure-by-chaining-the-appropriate-method-calls" style="color: inherit; text-decoration: none;">
  <h3>Create a data structure by chaining the appropriate method calls</h3>
</a>
<pre><code class="language-ts"><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">Struct</span><span class="hl-1"> = </span><span class="hl-5">require</span><span class="hl-1">(</span><span class="hl-6">&#39;typed-struct&#39;</span><span class="hl-1">).</span><span class="hl-7">default</span><span class="hl-1">;</span><br/><span class="hl-8">// or</span><br/><span class="hl-9">import</span><span class="hl-1"> </span><span class="hl-7">Struct</span><span class="hl-1"> </span><span class="hl-9">from</span><span class="hl-1"> </span><span class="hl-6">&#39;typed-struct&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">MyStructure</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Struct</span><span class="hl-1">(</span><span class="hl-6">&#39;MyStructure&#39;</span><span class="hl-1">) </span><span class="hl-8">// give a name to the constructor</span><br/><span class="hl-1">  .</span><span class="hl-5">Int8</span><span class="hl-1">(</span><span class="hl-6">&#39;foo&#39;</span><span class="hl-1">)        </span><span class="hl-8">// signed 8-bit integer field `foo`</span><br/><span class="hl-1">  .</span><span class="hl-5">UInt16LE</span><span class="hl-1">(</span><span class="hl-6">&#39;bar&#39;</span><span class="hl-1">)    </span><span class="hl-8">// unsigned, little-endian 16-bit integer field `bar`</span><br/><span class="hl-1">  .</span><span class="hl-5">compile</span><span class="hl-1">();         </span><span class="hl-8">// create a constructor for the structure, called last</span><br/><br/><span class="hl-8">// You can use the compiled constructor as if you had made a class.</span><br/><span class="hl-8">// If you are using a typescript, you will also get</span><br/><span class="hl-8">// the exact type of the generated structure</span><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">item1</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">MyStructure</span><span class="hl-1">();      </span><span class="hl-8">// creates an instance</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">item1</span><span class="hl-1">.</span><span class="hl-7">constructor</span><span class="hl-1">.</span><span class="hl-7">name</span><span class="hl-1">).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-6">&#39;MyStructure&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-8">// This class has useful static properties and methods.</span><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">raw</span><span class="hl-1"> = </span><span class="hl-7">MyStructure</span><span class="hl-1">.</span><span class="hl-5">raw</span><span class="hl-1">(</span><span class="hl-7">item1</span><span class="hl-1">);   </span><span class="hl-8">// get the underlying buffer</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">MyStructure</span><span class="hl-1">.</span><span class="hl-7">baseSize</span><span class="hl-1">).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-4">3</span><span class="hl-1">); </span><span class="hl-8">// the minimum base size of the structure</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">raw</span><span class="hl-1">.</span><span class="hl-7">length</span><span class="hl-1">).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-7">MyStructure</span><span class="hl-1">.</span><span class="hl-7">baseSize</span><span class="hl-1">);</span><br/><br/><span class="hl-8">// Changing the properties of the structure</span><br/><span class="hl-8">// changes the underlying buffer</span><br/><span class="hl-7">item1</span><span class="hl-1">.</span><span class="hl-7">foo</span><span class="hl-1"> = </span><span class="hl-4">0x56</span><span class="hl-1">;</span><br/><span class="hl-7">item1</span><span class="hl-1">.</span><span class="hl-7">bar</span><span class="hl-1"> = </span><span class="hl-4">0x1234</span><span class="hl-1">;</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">raw</span><span class="hl-1">).</span><span class="hl-5">toEqual</span><span class="hl-1">(</span><span class="hl-7">Buffer</span><span class="hl-1">.</span><span class="hl-5">from</span><span class="hl-1">([</span><span class="hl-4">0x56</span><span class="hl-1">, </span><span class="hl-4">0x34</span><span class="hl-1">, </span><span class="hl-4">0x12</span><span class="hl-1">]))</span><br/><br/><span class="hl-8">// ... and vice versa</span><br/><span class="hl-7">raw</span><span class="hl-1">[</span><span class="hl-4">0</span><span class="hl-1">] = </span><span class="hl-4">0</span><span class="hl-1">;</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">item1</span><span class="hl-1">.</span><span class="hl-7">foo</span><span class="hl-1">).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-4">0</span><span class="hl-1">);</span><br/><br/><span class="hl-8">// deserialization</span><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">item2</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">MyStructure</span><span class="hl-1">([</span><span class="hl-4">0x11</span><span class="hl-1">, </span><span class="hl-4">0x22</span><span class="hl-1">, </span><span class="hl-4">0x33</span><span class="hl-1">]);</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">item2</span><span class="hl-1">.</span><span class="hl-7">foo</span><span class="hl-1">).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-4">0x11</span><span class="hl-1">);</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">item2</span><span class="hl-1">.</span><span class="hl-7">bar</span><span class="hl-1">).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-4">0x3322</span><span class="hl-1">);</span>
</code></pre>

<a href="#typed-arrays" id="typed-arrays" style="color: inherit; text-decoration: none;">
  <h3>Typed arrays</h3>
</a>
<pre><code class="language-ts"><span class="hl-9">import</span><span class="hl-1"> </span><span class="hl-7">Struct</span><span class="hl-1"> </span><span class="hl-9">from</span><span class="hl-1"> </span><span class="hl-6">&#39;typed-struct&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">Foo</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Struct</span><span class="hl-1">(</span><span class="hl-6">&#39;Foo&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">UInt16Array</span><span class="hl-1">(</span><span class="hl-6">&#39;items&#39;</span><span class="hl-1">, </span><span class="hl-4">10</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">compile</span><span class="hl-1">();</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">foo</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Foo</span><span class="hl-1">();</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">foo</span><span class="hl-1">.</span><span class="hl-7">items</span><span class="hl-1">).</span><span class="hl-5">toHaveLength</span><span class="hl-1">(</span><span class="hl-4">10</span><span class="hl-1">);</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">foo</span><span class="hl-1">.</span><span class="hl-7">items</span><span class="hl-1">).</span><span class="hl-5">toBeInstanceOf</span><span class="hl-1">(</span><span class="hl-3">Uint16Array</span><span class="hl-1">);</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">Foo</span><span class="hl-1">.</span><span class="hl-5">raw</span><span class="hl-1">(</span><span class="hl-7">foo</span><span class="hl-1">)).</span><span class="hl-5">toHaveLength</span><span class="hl-1">(</span><span class="hl-4">20</span><span class="hl-1">);</span><br/><br/><span class="hl-8">// If the byte order in the system is different from that used in the data,</span><br/><span class="hl-8">// use `swap` method</span><br/><span class="hl-7">Foo</span><span class="hl-1">.</span><span class="hl-5">swap</span><span class="hl-1">(</span><span class="hl-7">foo</span><span class="hl-1">, </span><span class="hl-6">&#39;items&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-8">// ...</span><br/><br/><span class="hl-8">// change back</span><br/><span class="hl-7">Foo</span><span class="hl-1">.</span><span class="hl-5">swap</span><span class="hl-1">(</span><span class="hl-7">foo</span><span class="hl-1">, </span><span class="hl-6">&#39;items&#39;</span><span class="hl-1">);</span>
</code></pre>

<a href="#array-of-structures" id="array-of-structures" style="color: inherit; text-decoration: none;">
  <h3>Array of structures</h3>
</a>
<p>Using the structure <code>MyStructure</code> from the previous examples</p>
<pre><code class="language-ts"><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">Baz</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Struct</span><span class="hl-1">(</span><span class="hl-6">&#39;Baz&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">StructArray</span><span class="hl-1">(</span><span class="hl-6">&#39;structs&#39;</span><span class="hl-1">, </span><span class="hl-7">MyStructure</span><span class="hl-1">, </span><span class="hl-4">10</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">compile</span><span class="hl-1">();</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">baz</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Baz</span><span class="hl-1">();</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">baz</span><span class="hl-1">.</span><span class="hl-7">structs</span><span class="hl-1">).</span><span class="hl-5">toHaveLength</span><span class="hl-1">(</span><span class="hl-4">10</span><span class="hl-1">);</span><br/><span class="hl-7">baz</span><span class="hl-1">.</span><span class="hl-7">structs</span><span class="hl-1">[</span><span class="hl-4">3</span><span class="hl-1">].</span><span class="hl-7">foo</span><span class="hl-1"> = </span><span class="hl-4">123</span><span class="hl-1">;</span><br/><span class="hl-8">// but</span><br/><span class="hl-5">expect</span><span class="hl-1">(() </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">baz</span><span class="hl-1">.</span><span class="hl-7">struct</span><span class="hl-1">[</span><span class="hl-4">3</span><span class="hl-1">] = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">MyStructure</span><span class="hl-1">();</span><br/><span class="hl-1">}).</span><span class="hl-5">toThrow</span><span class="hl-1">(</span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-3">TypeError</span><span class="hl-1">(</span><span class="hl-6">&#39;Cannot assign to read only property &quot;3&quot;&#39;</span><span class="hl-1">))</span><br/><br/><span class="hl-5">expect</span><span class="hl-1">(() </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">baz</span><span class="hl-1">.</span><span class="hl-7">structs</span><span class="hl-1">.</span><span class="hl-5">push</span><span class="hl-1">(</span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">MyStructure</span><span class="hl-1">());</span><br/><span class="hl-1">}).</span><span class="hl-5">toThrow</span><span class="hl-1">(</span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">TypedError</span><span class="hl-1">(</span><span class="hl-6">&#39;Cannot add property 10, object is not extensible&#39;</span><span class="hl-1">));</span><br/>
</code></pre>

<a href="#nested-types" id="nested-types" style="color: inherit; text-decoration: none;">
  <h3>Nested types</h3>
</a>
<p>Using the structure <code>MyStructure</code> from the previous examples</p>
<pre><code class="language-ts"><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">Bat</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Struct</span><span class="hl-1">(</span><span class="hl-6">&#39;Bat&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">Float64LE</span><span class="hl-1">(</span><span class="hl-6">&#39;baz&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">Struct</span><span class="hl-1">(</span><span class="hl-6">&#39;quux&#39;</span><span class="hl-1">, </span><span class="hl-7">MyStructure</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">compile</span><span class="hl-1">();</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">bat</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Bat</span><span class="hl-1">();</span><br/><span class="hl-7">bat</span><span class="hl-1">.</span><span class="hl-7">quux</span><span class="hl-1">.</span><span class="hl-7">foo</span><span class="hl-1"> = </span><span class="hl-4">123</span><span class="hl-1">;</span><br/><span class="hl-7">bat</span><span class="hl-1">.</span><span class="hl-7">quux</span><span class="hl-1">.</span><span class="hl-7">bar</span><span class="hl-1"> = </span><span class="hl-4">82345</span><span class="hl-1">;</span><br/><span class="hl-7">bat</span><span class="hl-1">.</span><span class="hl-7">baz</span><span class="hl-1"> = </span><span class="hl-4">3.14</span><span class="hl-1">;</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">Xyz</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Struct</span><span class="hl-1">(</span><span class="hl-6">&#39;Xyz&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">Struct</span><span class="hl-1">(</span><span class="hl-6">&#39;bat&#39;</span><span class="hl-1">, </span><span class="hl-7">Bat</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">compile</span><span class="hl-1">();</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">xyz</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Xyz</span><span class="hl-1">();</span><br/><span class="hl-7">xyz</span><span class="hl-1">.</span><span class="hl-7">bat</span><span class="hl-1">.</span><span class="hl-7">quux</span><span class="hl-1">.</span><span class="hl-7">foo</span><span class="hl-1"> = </span><span class="hl-4">123</span><span class="hl-1">;</span><br/><br/><span class="hl-8">// but assignment to structure field is not allowed</span><br/><span class="hl-5">expect</span><span class="hl-1">(() </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">xyz</span><span class="hl-1">.</span><span class="hl-7">bat</span><span class="hl-1"> = </span><span class="hl-7">bat</span><span class="hl-1">;</span><br/><span class="hl-1">}).</span><span class="hl-5">toThrow</span><span class="hl-1">(</span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-3">TypeError</span><span class="hl-1">(</span><span class="hl-6">&#39;Cannot assign to read only property bat&#39;</span><span class="hl-1">))</span>
</code></pre>

<a href="#unions" id="unions" style="color: inherit; text-decoration: none;">
  <h3>Unions</h3>
</a>
<pre><code class="language-ts"><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">Word</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Struct</span><span class="hl-1">(</span><span class="hl-6">&#39;Word&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">UInt16LE</span><span class="hl-1">(</span><span class="hl-6">&#39;value&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-8">// We take a step back or two bytes back, which the previous field takes up</span><br/><span class="hl-1">  </span><span class="hl-8">// you can also use `seek` method with a negative argument</span><br/><span class="hl-1">  .</span><span class="hl-5">back</span><span class="hl-1">()</span><br/><span class="hl-1">  .</span><span class="hl-5">UInt8</span><span class="hl-1">(</span><span class="hl-6">&#39;low&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">UInt8</span><span class="hl-1">(</span><span class="hl-6">&#39;high&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">compile</span><span class="hl-1">();</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">word</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Word</span><span class="hl-1">();</span><br/><span class="hl-7">word</span><span class="hl-1">.</span><span class="hl-7">value</span><span class="hl-1"> = </span><span class="hl-4">0x1234</span><span class="hl-1">;</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">word</span><span class="hl-1">.</span><span class="hl-7">low</span><span class="hl-1">).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-4">0x34</span><span class="hl-1">);</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">word</span><span class="hl-1">.</span><span class="hl-7">high</span><span class="hl-1">).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-4">0x12</span><span class="hl-1">);</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">Word</span><span class="hl-1">.</span><span class="hl-7">baseSize</span><span class="hl-1">).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-4">2</span><span class="hl-1">);</span>
</code></pre>

<a href="#custom-types" id="custom-types" style="color: inherit; text-decoration: none;">
  <h3>Custom types</h3>
</a>
<pre><code class="language-ts"><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">BirthCertificate</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Struct</span><span class="hl-1">(</span><span class="hl-6">&#39;BirthCertificate&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">Custom</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-6">&#39;birthday&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-4">8</span><span class="hl-1">, </span><span class="hl-8">// size</span><br/><span class="hl-1">    </span><span class="hl-8">// getter, must return property value or `undefined` for unknown type</span><br/><span class="hl-1">    (</span><span class="hl-7">type</span><span class="hl-1">, </span><span class="hl-7">buf</span><span class="hl-1">) </span><span class="hl-0">=&gt;</span><span class="hl-1"> </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-3">Date</span><span class="hl-1">(</span><span class="hl-7">buf</span><span class="hl-1">.</span><span class="hl-5">readDoubleLE</span><span class="hl-1">() * </span><span class="hl-4">1000</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-8">// setter, must return `false` for unknown type or `true` if everything is ok</span><br/><span class="hl-1">    (</span><span class="hl-7">type</span><span class="hl-1">, </span><span class="hl-7">buf</span><span class="hl-1">, </span><span class="hl-7">value</span><span class="hl-1">) </span><span class="hl-0">=&gt;</span><span class="hl-1"> </span><span class="hl-7">buf</span><span class="hl-1">.</span><span class="hl-5">writeDoubleLE</span><span class="hl-1">(</span><span class="hl-7">value</span><span class="hl-1">.</span><span class="hl-5">getTime</span><span class="hl-1">() / </span><span class="hl-4">1000</span><span class="hl-1">) &gt; </span><span class="hl-4">0</span><br/><span class="hl-1">  )</span><br/><span class="hl-1">  .</span><span class="hl-5">compile</span><span class="hl-1">();</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">BirthCertificate</span><span class="hl-1">.</span><span class="hl-7">baseSize</span><span class="hl-1">).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-4">8</span><span class="hl-1">);</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">cert</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">BirthCertificate</span><span class="hl-1">();</span><br/><span class="hl-7">cert</span><span class="hl-1">.</span><span class="hl-7">birthday</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-3">Date</span><span class="hl-1">(</span><span class="hl-4">1973</span><span class="hl-1">, </span><span class="hl-4">6</span><span class="hl-1">, </span><span class="hl-4">15</span><span class="hl-1">);</span>
</code></pre>

<a href="#aliases" id="aliases" style="color: inherit; text-decoration: none;">
  <h3>Aliases</h3>
</a>
<p>Using the structure <code>BirthCertificate</code> from the previous example.</p>
<pre><code class="language-ts"><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">Twins</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Struct</span><span class="hl-1">(</span><span class="hl-6">&#39;Twins&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-8">// `John` and `Jimmy` properties are equivalent</span><br/><span class="hl-1">  .</span><span class="hl-5">Struct</span><span class="hl-1">([</span><span class="hl-6">&#39;John&#39;</span><span class="hl-1">, </span><span class="hl-6">&#39;Jimmy&#39;</span><span class="hl-1">], </span><span class="hl-7">BirthCertificate</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">compile</span><span class="hl-1">();</span><br/><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">Twins</span><span class="hl-1">.</span><span class="hl-7">baseSize</span><span class="hl-1">).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-4">8</span><span class="hl-1">);</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">twins</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Twins</span><span class="hl-1">();</span><br/><span class="hl-7">twins</span><span class="hl-1">.</span><span class="hl-7">John</span><span class="hl-1">.</span><span class="hl-7">birthday</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-3">Date</span><span class="hl-1">(</span><span class="hl-4">1973</span><span class="hl-1">, </span><span class="hl-4">6</span><span class="hl-1">, </span><span class="hl-4">15</span><span class="hl-1">);</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">twins</span><span class="hl-1">.</span><span class="hl-7">Jimmy</span><span class="hl-1">.</span><span class="hl-7">birthday</span><span class="hl-1">).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-7">twins</span><span class="hl-1">.</span><span class="hl-7">John</span><span class="hl-1">.</span><span class="hl-7">birthday</span><span class="hl-1">);</span>
</code></pre>

<a href="#fixed-values" id="fixed-values" style="color: inherit; text-decoration: none;">
  <h3>Fixed values</h3>
</a>
<pre><code class="language-ts"><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">Request</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Struct</span><span class="hl-1">(</span><span class="hl-6">&#39;Request&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">UInt32BE</span><span class="hl-1">(</span><span class="hl-6">&#39;header&#39;</span><span class="hl-1">, </span><span class="hl-4">0xDEADBEEF</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">Buffer</span><span class="hl-1">(</span><span class="hl-6">&#39;data&#39;</span><span class="hl-1">, </span><span class="hl-4">16</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">compile</span><span class="hl-1">();</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">req</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Request</span><span class="hl-1">();</span><br/><br/><span class="hl-8">// `header` property is initialized in the constructor</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">req</span><span class="hl-1">.</span><span class="hl-7">header</span><span class="hl-1">).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-4">0xDEADBEEF</span><span class="hl-1">);</span><br/><br/><span class="hl-8">// Assigning a value other than the specified one is not allowed</span><br/><span class="hl-5">expect</span><span class="hl-1">(() </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-8">// eslint or IDE will also indicate an error</span><br/><span class="hl-1">  </span><span class="hl-7">req</span><span class="hl-1">.</span><span class="hl-7">header</span><span class="hl-1"> = </span><span class="hl-4">0xDEADC0DE</span><span class="hl-1">;</span><br/><span class="hl-1">}).</span><span class="hl-5">toThrow</span><span class="hl-1">(</span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-3">TypeError</span><span class="hl-1">(</span><span class="hl-6">`Invalid value, expected 0xDEADBEEF`</span><span class="hl-1">));</span><br/><br/><span class="hl-8">// ... but</span><br/><span class="hl-7">req</span><span class="hl-1">.</span><span class="hl-7">header</span><span class="hl-1"> = </span><span class="hl-4">0xDEADBEEF</span><span class="hl-1">;</span>
</code></pre>

<a href="#enumerated-fields-typescript" id="enumerated-fields-typescript" style="color: inherit; text-decoration: none;">
  <h3>Enumerated fields (Typescript)</h3>
</a>
<pre><code class="language-ts"><span class="hl-9">import</span><span class="hl-1"> </span><span class="hl-7">Struct</span><span class="hl-1">, { </span><span class="hl-7">typed</span><span class="hl-1"> } </span><span class="hl-9">from</span><span class="hl-1"> </span><span class="hl-6">&#39;typed-struct&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">enum</span><span class="hl-1"> </span><span class="hl-3">ErrorType</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-2">Success</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">Timeout</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">InvalidCommand</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">ServerError</span><span class="hl-1">,</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">REQUEST</span><span class="hl-1"> = </span><span class="hl-4">0xAA</span><span class="hl-1">;</span><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">RESPONSE</span><span class="hl-1"> = </span><span class="hl-4">0x55</span><span class="hl-1">;</span><br/><br/><span class="hl-8">// Numeric type refinement</span><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">OperationResult</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Struct</span><span class="hl-1">()</span><br/><span class="hl-1">  .</span><span class="hl-5">UInt8</span><span class="hl-1">(</span><span class="hl-6">&#39;operation&#39;</span><span class="hl-1">, </span><span class="hl-7">typed</span><span class="hl-1">&lt;</span><span class="hl-4">1</span><span class="hl-1"> | </span><span class="hl-4">2</span><span class="hl-1"> | </span><span class="hl-4">3</span><span class="hl-1"> | </span><span class="hl-4">19</span><span class="hl-1">&gt;())</span><br/><span class="hl-1">  .</span><span class="hl-5">UInt8</span><span class="hl-1">(</span><span class="hl-6">&#39;type&#39;</span><span class="hl-1">, </span><span class="hl-5">typed</span><span class="hl-1">&lt;</span><span class="hl-0">typeof</span><span class="hl-1"> </span><span class="hl-2">REQUEST</span><span class="hl-1"> | </span><span class="hl-0">typeof</span><span class="hl-1"> </span><span class="hl-2">RESPONSE</span><span class="hl-1">&gt;())</span><br/><span class="hl-1">  .</span><span class="hl-5">UInt8</span><span class="hl-1">(</span><span class="hl-6">&#39;error&#39;</span><span class="hl-1">, </span><span class="hl-5">typed</span><span class="hl-1">&lt;</span><span class="hl-3">ErrorType</span><span class="hl-1">&gt;())</span><br/><span class="hl-1">  .</span><span class="hl-5">compile</span><span class="hl-1">();</span><br/><br/><span class="hl-8">/*</span><br/><span class="hl-8">type OperationResult = {</span><br/><span class="hl-8">  operation: 1 | 2 | 3 | 19;</span><br/><span class="hl-8">  type: 0xAA | 0x55;</span><br/><span class="hl-8">  error: ErrorType;</span><br/><span class="hl-8">}</span><br/><span class="hl-8">*/</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">res</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">OperationResult</span><span class="hl-1">();</span><br/><span class="hl-7">res</span><span class="hl-1">.</span><span class="hl-7">error</span><span class="hl-1"> = </span><span class="hl-7">ErrorType</span><span class="hl-1">.</span><span class="hl-7">Success</span><span class="hl-1">;</span>
</code></pre>

<a href="#variable-length-structures" id="variable-length-structures" style="color: inherit; text-decoration: none;">
  <h3>Variable length structures</h3>
</a>
<pre><code class="language-ts"><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">Package</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Struct</span><span class="hl-1">(</span><span class="hl-6">&#39;Package&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">UInt16LE</span><span class="hl-1">(</span><span class="hl-6">&#39;length&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-8">// If you do not specify the length of the buffer,</span><br/><span class="hl-1">  </span><span class="hl-8">// it will take all the remaining space.</span><br/><span class="hl-1">  </span><span class="hl-8">// There can only be one such field, and it must be the last.</span><br/><span class="hl-1">  </span><span class="hl-8">// You can specify a negative buffer length (-N),</span><br/><span class="hl-1">  </span><span class="hl-8">// then the buffer will take up all space except for the last N bytes</span><br/><span class="hl-1">  </span><span class="hl-8">// Since the size of the buffer is unknown, `baseSize` ignores its length.</span><br/><span class="hl-1">  .</span><span class="hl-5">Buffer</span><span class="hl-1">(</span><span class="hl-6">&#39;data&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">compile</span><span class="hl-1">();</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">Package</span><span class="hl-1">.</span><span class="hl-7">baseSize</span><span class="hl-1">).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-4">2</span><span class="hl-1">);</span><br/><br/><span class="hl-0">function</span><span class="hl-1"> </span><span class="hl-5">createPackage</span><span class="hl-1">(</span><span class="hl-7">data</span><span class="hl-1">: </span><span class="hl-3">Buffer</span><span class="hl-1">): </span><span class="hl-3">Package</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">pkg</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Package</span><span class="hl-1">(</span><span class="hl-7">Package</span><span class="hl-1">.</span><span class="hl-7">baseSize</span><span class="hl-1"> + </span><span class="hl-7">data</span><span class="hl-1">.</span><span class="hl-7">length</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-7">data</span><span class="hl-1">.</span><span class="hl-5">copy</span><span class="hl-1">(</span><span class="hl-7">pkg</span><span class="hl-1">.</span><span class="hl-7">data</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-7">pkg</span><span class="hl-1">.</span><span class="hl-7">length</span><span class="hl-1"> = </span><span class="hl-7">data</span><span class="hl-1">.</span><span class="hl-7">length</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-9">return</span><span class="hl-1"> </span><span class="hl-7">pkg</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code></pre>

<a href="#crc" id="crc" style="color: inherit; text-decoration: none;">
  <h3>CRC</h3>
</a>
<p>The checksum is often used to verify data integrity,
it is usually stored in the last bytes of the buffer.</p>
<pre><code class="language-ts"><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">Exact</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Struct</span><span class="hl-1">(</span><span class="hl-6">&#39;Exact&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">UInt16LE</span><span class="hl-1">(</span><span class="hl-6">&#39;length&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">Buffer</span><span class="hl-1">(</span><span class="hl-6">&#39;data&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-8">// Only the checksum can go after the tail buffer</span><br/><span class="hl-1">  .</span><span class="hl-5">CRC16LE</span><span class="hl-1">(</span><span class="hl-6">&#39;crc&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">compile</span><span class="hl-1">();</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">Exact</span><span class="hl-1">.</span><span class="hl-7">baseSize</span><span class="hl-1">).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-4">4</span><span class="hl-1">);</span>
</code></pre>
<p>If you pass the checksum function as parameters, then your structure will have the static <code>crc</code> method that you can use to calculate and update this field.</p>
<p>Let&#39;s slightly modify the previous example:</p>
<pre><code class="language-ts"><span class="hl-9">import</span><span class="hl-1"> { </span><span class="hl-7">crc16</span><span class="hl-1"> } </span><span class="hl-9">from</span><span class="hl-1"> </span><span class="hl-6">&#39;crc&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">Exact</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Struct</span><span class="hl-1">(</span><span class="hl-6">&#39;Exact&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">UInt16LE</span><span class="hl-1">(</span><span class="hl-6">&#39;length&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">Buffer</span><span class="hl-1">(</span><span class="hl-6">&#39;data&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-8">// checksum function and initial value</span><br/><span class="hl-1">  .</span><span class="hl-5">CRC16LE</span><span class="hl-1">(</span><span class="hl-6">&#39;crc&#39;</span><span class="hl-1">, </span><span class="hl-7">crc16</span><span class="hl-1">, </span><span class="hl-4">0xffff</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">compile</span><span class="hl-1">();</span><br/><br/><span class="hl-0">function</span><span class="hl-1"> </span><span class="hl-5">createExact</span><span class="hl-1">(</span><span class="hl-7">data</span><span class="hl-1">: </span><span class="hl-3">Buffer</span><span class="hl-1">): </span><span class="hl-3">Exact</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">item</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Exact</span><span class="hl-1">(</span><span class="hl-7">Exact</span><span class="hl-1">.</span><span class="hl-7">baseSize</span><span class="hl-1"> + </span><span class="hl-7">data</span><span class="hl-1">.</span><span class="hl-7">length</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-7">data</span><span class="hl-1">.</span><span class="hl-5">copy</span><span class="hl-1">(</span><span class="hl-7">item</span><span class="hl-1">.</span><span class="hl-7">data</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-7">item</span><span class="hl-1">.</span><span class="hl-7">length</span><span class="hl-1"> = </span><span class="hl-7">data</span><span class="hl-1">.</span><span class="hl-7">length</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-8">// New static method `Exact.crc`</span><br/><span class="hl-1">  </span><span class="hl-7">item</span><span class="hl-1">.</span><span class="hl-7">crc</span><span class="hl-1"> = </span><span class="hl-7">Exact</span><span class="hl-1">.</span><span class="hl-5">crc</span><span class="hl-1">(</span><span class="hl-7">item</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-8">// or the same thing - calculate and update the field</span><br/><span class="hl-1">  </span><span class="hl-7">Exact</span><span class="hl-1">.</span><span class="hl-5">crc</span><span class="hl-1">(</span><span class="hl-7">item</span><span class="hl-1">, </span><span class="hl-0">true</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-9">return</span><span class="hl-1"> </span><span class="hl-7">item</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code></pre>

<a href="#strings" id="strings" style="color: inherit; text-decoration: none;">
  <h3>Strings</h3>
</a>
<pre><code class="language-ts"><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">Person</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Struct</span><span class="hl-1">(</span><span class="hl-6">&#39;Person&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">String</span><span class="hl-1">(</span><span class="hl-6">&#39;name&#39;</span><span class="hl-1">, </span><span class="hl-4">30</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">String</span><span class="hl-1">(</span><span class="hl-6">&#39;surname&#39;</span><span class="hl-1">, </span><span class="hl-4">40</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">compile</span><span class="hl-1">();</span><br/><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">Person</span><span class="hl-1">.</span><span class="hl-7">baseSize</span><span class="hl-1">).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-4">70</span><span class="hl-1">);</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">walterGreen</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Person</span><span class="hl-1">();</span><br/><span class="hl-7">walterGreen</span><span class="hl-1">.</span><span class="hl-7">name</span><span class="hl-1"> = </span><span class="hl-6">&#39;Walter&#39;</span><span class="hl-1">;</span><br/><span class="hl-7">walterGreen</span><span class="hl-1">.</span><span class="hl-7">surname</span><span class="hl-1"> = </span><span class="hl-6">&#39;Green&#39;</span><span class="hl-1">;</span>
</code></pre>
<p>You can specify the encoding, the default is UTF8.
You can use the encodings supported by <a href="https://nodejs.org/dist/latest-v16.x/docs/api/buffer.html#buffer_buffers_and_character_encodings"><code>Buffer</code></a>
or install <a href="https://github.com/ashtuchkin/iconv-lite">iconv-lite</a> package
to add support for all encodings defined in this package.</p>
<pre><code class="language-ts"><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">Foo</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Struct</span><span class="hl-1">(</span><span class="hl-6">&#39;Foo&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-8">// Specify the desired encoding and size in bytes like this</span><br/><span class="hl-1">  .</span><span class="hl-5">String</span><span class="hl-1">(</span><span class="hl-6">&#39;bar&#39;</span><span class="hl-1">, </span><span class="hl-6">&#39;win1251&#39;</span><span class="hl-1">, </span><span class="hl-4">10</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-8">// or so</span><br/><span class="hl-1">  .</span><span class="hl-5">String</span><span class="hl-1">(</span><span class="hl-6">&#39;baz&#39;</span><span class="hl-1">, </span><span class="hl-4">10</span><span class="hl-1">, </span><span class="hl-6">&#39;ucs2&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-8">// or even so</span><br/><span class="hl-1">  .</span><span class="hl-5">String</span><span class="hl-1">(</span><span class="hl-6">&#39;quux&#39;</span><span class="hl-1">, { </span><span class="hl-7">length:</span><span class="hl-1"> </span><span class="hl-4">10</span><span class="hl-1">, </span><span class="hl-7">encoding:</span><span class="hl-1"> </span><span class="hl-6">&#39;koi8-r&#39;</span><span class="hl-1">, </span><span class="hl-7">literal:</span><span class="hl-1"> </span><span class="hl-6">&#39;Андрей&#39;</span><span class="hl-1"> })</span><br/><span class="hl-1">  .</span><span class="hl-5">compile</span><span class="hl-1">();</span>
</code></pre>
<p>If you do not specify the length, then the <code>string field</code> will take up all the remaining space.</p>

<a href="#string-arrays" id="string-arrays" style="color: inherit; text-decoration: none;">
  <h3>String Arrays</h3>
</a>
<pre><code class="language-ts"><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">Page</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Struct</span><span class="hl-1">(</span><span class="hl-6">&#39;Page&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">StringArray</span><span class="hl-1">(</span><span class="hl-6">&#39;body&#39;</span><span class="hl-1">, {</span><br/><span class="hl-1">    </span><span class="hl-7">length:</span><span class="hl-1"> </span><span class="hl-4">80</span><span class="hl-1">,        </span><span class="hl-8">// string length in bytes (required)</span><br/><span class="hl-1">    </span><span class="hl-7">lines:</span><span class="hl-1"> </span><span class="hl-4">25</span><span class="hl-1">,         </span><span class="hl-8">// number of lines (required)</span><br/><span class="hl-1">    </span><span class="hl-7">encoding:</span><span class="hl-1"> </span><span class="hl-6">&#39;ascii&#39;</span><br/><span class="hl-1">  })</span><br/><span class="hl-1">  .</span><span class="hl-5">compile</span><span class="hl-1">();</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">page</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Page</span><span class="hl-1">();</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">Page</span><span class="hl-1">.</span><span class="hl-7">baseSize</span><span class="hl-1">).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-4">80</span><span class="hl-1"> * </span><span class="hl-4">25</span><span class="hl-1">);</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-3">Array</span><span class="hl-1">.</span><span class="hl-5">isArray</span><span class="hl-1">(</span><span class="hl-7">page</span><span class="hl-1">.</span><span class="hl-7">body</span><span class="hl-1">)).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-0">true</span><span class="hl-1">);</span><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">body</span><span class="hl-1"> = </span><span class="hl-7">page</span><span class="hl-1">.</span><span class="hl-7">body</span><span class="hl-1">;</span><br/><span class="hl-7">body</span><span class="hl-1">[</span><span class="hl-4">0</span><span class="hl-1">] = </span><span class="hl-6">&#39;Lorem ipsum&#39;</span><span class="hl-1">;</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">page</span><span class="hl-1">.</span><span class="hl-7">body</span><span class="hl-1">[</span><span class="hl-4">0</span><span class="hl-1">]).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-7">body</span><span class="hl-1">[</span><span class="hl-4">0</span><span class="hl-1">]);</span><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">raw</span><span class="hl-1"> = </span><span class="hl-7">Page</span><span class="hl-1">.</span><span class="hl-5">raw</span><span class="hl-1">(</span><span class="hl-7">page</span><span class="hl-1">);</span><br/><span class="hl-7">raw</span><span class="hl-1">[</span><span class="hl-7">Page</span><span class="hl-1">.</span><span class="hl-5">getOffsetOf</span><span class="hl-1">(</span><span class="hl-6">&#39;body&#39;</span><span class="hl-1">)] = </span><span class="hl-6">&#39;l&#39;</span><span class="hl-1">.</span><span class="hl-5">charCodeAt</span><span class="hl-1">(</span><span class="hl-4">0</span><span class="hl-1">);</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">body</span><span class="hl-1">[</span><span class="hl-4">0</span><span class="hl-1">]).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-6">&#39;lorem ipsum&#39;</span><span class="hl-1">);</span><br/><span class="hl-7">console</span><span class="hl-1">.</span><span class="hl-5">log</span><span class="hl-1">(</span><span class="hl-7">page</span><span class="hl-1">);</span>
</code></pre>
<p>output</p>
<pre><code><span class="hl-7">Page</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-10">body</span><span class="hl-1">: [</span><br/><span class="hl-1">    </span><span class="hl-6">&#39;lorem ipsum&#39;</span><span class="hl-1">, </span><span class="hl-6">&#39;&#39;</span><span class="hl-1">, </span><span class="hl-6">&#39;&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-6">&#39;&#39;</span><span class="hl-1">,            </span><span class="hl-6">&#39;&#39;</span><span class="hl-1">, </span><span class="hl-6">&#39;&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-6">&#39;&#39;</span><span class="hl-1">,            </span><span class="hl-6">&#39;&#39;</span><span class="hl-1">, </span><span class="hl-6">&#39;&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-6">&#39;&#39;</span><span class="hl-1">,            </span><span class="hl-6">&#39;&#39;</span><span class="hl-1">, </span><span class="hl-6">&#39;&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-6">&#39;&#39;</span><span class="hl-1">,            </span><span class="hl-6">&#39;&#39;</span><span class="hl-1">, </span><span class="hl-6">&#39;&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-6">&#39;&#39;</span><span class="hl-1">,            </span><span class="hl-6">&#39;&#39;</span><span class="hl-1">, </span><span class="hl-6">&#39;&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-6">&#39;&#39;</span><span class="hl-1">,            </span><span class="hl-6">&#39;&#39;</span><span class="hl-1">, </span><span class="hl-6">&#39;&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-6">&#39;&#39;</span><span class="hl-1">,            </span><span class="hl-6">&#39;&#39;</span><span class="hl-1">, </span><span class="hl-6">&#39;&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-6">&#39;&#39;</span><br/><span class="hl-1">  ]</span><br/><span class="hl-1">}</span>
</code></pre>

<a href="#bit-fields" id="bit-fields" style="color: inherit; text-decoration: none;">
  <h3>Bit fields</h3>
</a>
<pre><code class="language-ts"><span class="hl-8">// |------&gt; bit order from the most significant bits to the least significant</span><br/><span class="hl-8">// 01234567 offset</span><br/><span class="hl-8">// 00011110 mask</span><br/><span class="hl-8">//    \  /</span><br/><span class="hl-8">//     \/</span><br/><span class="hl-8">// bit field with an offset of 3 bits and a length of 4 bits</span><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">Foo</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Struct</span><span class="hl-1">(</span><span class="hl-6">&#39;Foo&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">Bits8</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-8">// for each property, specify the offset and length</span><br/><span class="hl-1">    </span><span class="hl-7">high:</span><span class="hl-1"> [</span><span class="hl-4">0</span><span class="hl-1">, </span><span class="hl-4">4</span><span class="hl-1">],</span><br/><span class="hl-1">    </span><span class="hl-7">low:</span><span class="hl-1"> [</span><span class="hl-4">4</span><span class="hl-1">, </span><span class="hl-4">4</span><span class="hl-1">],</span><br/><span class="hl-1">    </span><span class="hl-8">// properties may overlap</span><br/><span class="hl-1">    </span><span class="hl-7">value:</span><span class="hl-1"> [</span><span class="hl-4">0</span><span class="hl-1">, </span><span class="hl-4">8</span><span class="hl-1">]</span><br/><span class="hl-1">  })</span><br/><span class="hl-1">  .</span><span class="hl-5">compile</span><span class="hl-1">();</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">Foo</span><span class="hl-1">.</span><span class="hl-7">baseSize</span><span class="hl-1">).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-4">1</span><span class="hl-1">);</span><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">foo</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Foo</span><span class="hl-1">();</span><br/><span class="hl-7">foo</span><span class="hl-1">.</span><span class="hl-7">value</span><span class="hl-1"> = </span><span class="hl-4">0x36</span><span class="hl-1">;</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">foo</span><span class="hl-1">.</span><span class="hl-7">high</span><span class="hl-1">).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-4">3</span><span class="hl-1">);</span><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">foo</span><span class="hl-1">.</span><span class="hl-7">low</span><span class="hl-1">).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-4">6</span><span class="hl-1">);</span>
</code></pre>

<a href="#reserved-fields" id="reserved-fields" style="color: inherit; text-decoration: none;">
  <h3>Reserved fields</h3>
</a>
<pre><code class="language-ts"><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">Bar</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Struct</span><span class="hl-1">(</span><span class="hl-6">&#39;Bar&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">Int16LE</span><span class="hl-1">(</span><span class="hl-6">&#39;baz&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  </span><span class="hl-8">// Skip two bytes.</span><br/><span class="hl-1">  </span><span class="hl-8">// You can use negative values for unions.</span><br/><span class="hl-1">  </span><span class="hl-8">// Zero moves the current pointer to the end.</span><br/><span class="hl-1">  .</span><span class="hl-5">seek</span><span class="hl-1">(</span><span class="hl-4">2</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">compile</span><span class="hl-1">();</span><br/><br/><span class="hl-5">expect</span><span class="hl-1">(</span><span class="hl-7">Bar</span><span class="hl-1">.</span><span class="hl-7">baseSize</span><span class="hl-1">).</span><span class="hl-5">toBe</span><span class="hl-1">(</span><span class="hl-4">4</span><span class="hl-1">);  </span>
</code></pre>

<a href="#json" id="json" style="color: inherit; text-decoration: none;">
  <h3>JSON</h3>
</a>
<p>e.g.</p>
<pre><code class="language-ts"><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">Model</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Struct</span><span class="hl-1">(</span><span class="hl-6">&#39;Model&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">Int8</span><span class="hl-1">(</span><span class="hl-6">&#39;foo&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">UInt8Array</span><span class="hl-1">(</span><span class="hl-6">&#39;bars&#39;</span><span class="hl-1">, </span><span class="hl-4">4</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">Struct</span><span class="hl-1">(</span><span class="hl-6">&#39;nested&#39;</span><span class="hl-1">, </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Struct</span><span class="hl-1">(</span><span class="hl-6">&#39;Nested&#39;</span><span class="hl-1">).</span><span class="hl-5">Int8</span><span class="hl-1">(</span><span class="hl-6">&#39;value&#39;</span><span class="hl-1">).</span><span class="hl-5">Buffer</span><span class="hl-1">(</span><span class="hl-6">&#39;items&#39;</span><span class="hl-1">, </span><span class="hl-4">4</span><span class="hl-1">).</span><span class="hl-5">compile</span><span class="hl-1">())</span><br/><span class="hl-1">  .</span><span class="hl-5">compile</span><span class="hl-1">();</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">model</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Model</span><span class="hl-1">([</span><span class="hl-4">0x10</span><span class="hl-1">, </span><span class="hl-4">1</span><span class="hl-1">, </span><span class="hl-4">2</span><span class="hl-1">, </span><span class="hl-4">3</span><span class="hl-1">, </span><span class="hl-4">4</span><span class="hl-1">, </span><span class="hl-4">0x20</span><span class="hl-1">, </span><span class="hl-4">5</span><span class="hl-1">, </span><span class="hl-4">6</span><span class="hl-1">, </span><span class="hl-4">7</span><span class="hl-1">, </span><span class="hl-4">8</span><span class="hl-1">]);</span>
</code></pre>
<p>Let&#39;s see what the <code>model</code> is</p>
<pre><code class="language-ts"><span class="hl-7">console</span><span class="hl-1">.</span><span class="hl-5">log</span><span class="hl-1">(</span><span class="hl-7">model</span><span class="hl-1">);</span>
</code></pre>
<p>output: (<code>$raw</code> is a hidden property and is shown for clarity)</p>
<pre><code><span class="hl-7">Model</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-10">foo</span><span class="hl-1">: [</span><span class="hl-7">Getter</span><span class="hl-1">/</span><span class="hl-7">Setter</span><span class="hl-1">],</span><br/><span class="hl-1">  </span><span class="hl-10">bars</span><span class="hl-1">: </span><span class="hl-3">Uint8Array</span><span class="hl-1">(</span><span class="hl-4">4</span><span class="hl-1">) [ </span><span class="hl-4">1</span><span class="hl-1">, </span><span class="hl-4">2</span><span class="hl-1">, </span><span class="hl-4">3</span><span class="hl-1">, </span><span class="hl-4">4</span><span class="hl-1"> ],</span><br/><span class="hl-1">  </span><span class="hl-10">nested</span><span class="hl-1">: </span><span class="hl-7">Nested</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-10">value</span><span class="hl-1">: [</span><span class="hl-7">Getter</span><span class="hl-1">/</span><span class="hl-7">Setter</span><span class="hl-1">],</span><br/><span class="hl-1">    </span><span class="hl-10">items</span><span class="hl-1">: &lt;</span><span class="hl-3">Buffer</span><span class="hl-1"> </span><span class="hl-4">05</span><span class="hl-1"> </span><span class="hl-4">06</span><span class="hl-1"> </span><span class="hl-4">07</span><span class="hl-1"> </span><span class="hl-4">08</span><span class="hl-1">&gt;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><span class="hl-10">$raw</span><span class="hl-1">: &lt;</span><span class="hl-3">Buffer</span><span class="hl-1"> </span><span class="hl-4">10</span><span class="hl-1"> </span><span class="hl-4">01</span><span class="hl-1"> </span><span class="hl-4">02</span><span class="hl-1"> </span><span class="hl-4">03</span><span class="hl-1"> </span><span class="hl-4">04</span><span class="hl-1"> </span><span class="hl-4">20</span><span class="hl-1"> </span><span class="hl-4">05</span><span class="hl-1"> </span><span class="hl-4">06</span><span class="hl-1"> </span><span class="hl-4">07</span><span class="hl-1"> </span><span class="hl-4">08</span><span class="hl-1">&gt;</span><br/><span class="hl-1">}</span>
</code></pre>
<p>If you only need a parser, you can avoid overheads like getters and setters
and hidden buffers by using the method <code>toJSON</code>. The result contains only data,
as opposed to methods or internal state. Its <code>prototype</code> is <code>Object.prototype</code> 
and all numeric iterable types (buffer, typed arrays) are replaced with <code>number[]</code>,
all custom types other than <code>number</code>, <code>boolean</code>, <code>string</code>, <code>string[]</code> and numeric
iterables are replaced with the result of executing <code>toJSON</code> or <code>toString</code> methods.</p>
<pre><code class="language-ts"><span class="hl-7">console</span><span class="hl-1">.</span><span class="hl-5">log</span><span class="hl-1">(</span><span class="hl-7">model</span><span class="hl-1">.</span><span class="hl-5">toJSON</span><span class="hl-1">());</span>
</code></pre>
<p>output:</p>
<pre><code><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-10">foo</span><span class="hl-1">: </span><span class="hl-4">16</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-10">bars</span><span class="hl-1">: [ </span><span class="hl-4">1</span><span class="hl-1">, </span><span class="hl-4">2</span><span class="hl-1">, </span><span class="hl-4">3</span><span class="hl-1">, </span><span class="hl-4">4</span><span class="hl-1"> ],</span><br/><span class="hl-1">  </span><span class="hl-10">nested</span><span class="hl-1">: { </span><span class="hl-10">value</span><span class="hl-1">: </span><span class="hl-4">32</span><span class="hl-1">, </span><span class="hl-10">items</span><span class="hl-1">: [ </span><span class="hl-4">5</span><span class="hl-1">, </span><span class="hl-4">6</span><span class="hl-1">, </span><span class="hl-4">7</span><span class="hl-1">, </span><span class="hl-4">8</span><span class="hl-1"> ] }</span><br/><span class="hl-1">}</span>
</code></pre>

<a href="#a-typical-example-of-working-with-binary-data-via-a-serial-port" id="a-typical-example-of-working-with-binary-data-via-a-serial-port" style="color: inherit; text-decoration: none;">
  <h3>A typical example of working with binary data via a serial port</h3>
</a>
<p>Package.ts</p>
<pre><code class="language-ts"><span class="hl-9">import</span><span class="hl-1"> </span><span class="hl-7">Struct</span><span class="hl-1">, { </span><span class="hl-7">typed</span><span class="hl-1">, </span><span class="hl-7">ExtractType</span><span class="hl-1"> } </span><span class="hl-9">from</span><span class="hl-1"> </span><span class="hl-6">&#39;typed-struct&#39;</span><span class="hl-1">;</span><br/><span class="hl-9">import</span><span class="hl-1"> { </span><span class="hl-7">crc16</span><span class="hl-1"> } </span><span class="hl-9">from</span><span class="hl-1"> </span><span class="hl-6">&#39;crc&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-9">export</span><span class="hl-1"> </span><span class="hl-0">enum</span><span class="hl-1"> </span><span class="hl-3">Command</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-2">Read</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">Write</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">Reset</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">Halt</span><span class="hl-1">,</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-9">export</span><span class="hl-1"> </span><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">PREAMBLE</span><span class="hl-1"> = </span><span class="hl-4">0x1234</span><span class="hl-1">;</span><br/><br/><span class="hl-8">/**</span><br/><span class="hl-8"> * Variable length structure </span><br/><span class="hl-8"> * Package.baseSize = 9 - minimal structure size</span><br/><span class="hl-8"> */</span><br/><span class="hl-9">export</span><span class="hl-1"> </span><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">Package</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Struct</span><span class="hl-1">(</span><span class="hl-6">&#39;Package&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">UInt16BE</span><span class="hl-1">(</span><span class="hl-6">&#39;header&#39;</span><span class="hl-1">, </span><span class="hl-2">PREAMBLE</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">UInt8</span><span class="hl-1">(</span><span class="hl-6">&#39;source&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">UInt8</span><span class="hl-1">(</span><span class="hl-6">&#39;destination&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">UInt8</span><span class="hl-1">(</span><span class="hl-6">&#39;command&#39;</span><span class="hl-1">, </span><span class="hl-5">typed</span><span class="hl-1">&lt;</span><span class="hl-3">Command</span><span class="hl-1">&gt;())</span><br/><span class="hl-1">  .</span><span class="hl-5">UInt16LE</span><span class="hl-1">(</span><span class="hl-6">&#39;length&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">Buffer</span><span class="hl-1">(</span><span class="hl-6">&#39;data&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">CRC16LE</span><span class="hl-1">(</span><span class="hl-6">&#39;crc&#39;</span><span class="hl-1">, </span><span class="hl-7">crc16</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-5">compile</span><span class="hl-1">();</span><br/><br/><span class="hl-8">// it&#39;s not obligatory</span><br/><span class="hl-9">export</span><span class="hl-1"> </span><span class="hl-0">type</span><span class="hl-1"> </span><span class="hl-3">Package</span><span class="hl-1"> = </span><span class="hl-3">ExtractType</span><span class="hl-1">&lt;</span><span class="hl-0">typeof</span><span class="hl-1"> </span><span class="hl-7">Package</span><span class="hl-1">&gt;;</span><br/><span class="hl-8">/*</span><br/><span class="hl-8">type Package = {</span><br/><span class="hl-8">  header: 0x1234;</span><br/><span class="hl-8">  source: number;</span><br/><span class="hl-8">  destination: number;</span><br/><span class="hl-8">  command: Command;</span><br/><span class="hl-8">  length: number;</span><br/><span class="hl-8">  data: Buffer;</span><br/><span class="hl-8">  crc: number;</span><br/><span class="hl-8">}</span><br/><span class="hl-8"> */</span>
</code></pre>
<p>Decoder.ts</p>
<pre><code class="language-ts"><span class="hl-9">import</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">Transform</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-7">TransformOptions</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-7">TransformCallback</span><br/><span class="hl-1">} </span><span class="hl-9">from</span><span class="hl-1"> </span><span class="hl-6">&#39;stream&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-9">import</span><span class="hl-1"> { </span><span class="hl-7">Package</span><span class="hl-1">, </span><span class="hl-7">PREAMBLE</span><span class="hl-1"> } </span><span class="hl-9">from</span><span class="hl-1"> </span><span class="hl-6">&#39;./Package&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">preamble</span><span class="hl-1"> = </span><span class="hl-7">Buffer</span><span class="hl-1">.</span><span class="hl-5">alloc</span><span class="hl-1">(</span><span class="hl-4">2</span><span class="hl-1">);</span><br/><span class="hl-7">preamble</span><span class="hl-1">.</span><span class="hl-5">writeInt16BE</span><span class="hl-1">(</span><span class="hl-2">PREAMBLE</span><span class="hl-1">);</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">empty</span><span class="hl-1"> = </span><span class="hl-7">Buffer</span><span class="hl-1">.</span><span class="hl-5">alloc</span><span class="hl-1">(</span><span class="hl-4">0</span><span class="hl-1">);</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">lengthOffset</span><span class="hl-1"> = </span><span class="hl-7">Package</span><span class="hl-1">.</span><span class="hl-5">getOffsetOf</span><span class="hl-1">(</span><span class="hl-6">&#39;length&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-9">export</span><span class="hl-1"> </span><span class="hl-9">default</span><span class="hl-1"> </span><span class="hl-0">class</span><span class="hl-1"> </span><span class="hl-3">Decoder</span><span class="hl-1"> </span><span class="hl-0">extends</span><span class="hl-1"> </span><span class="hl-3">Transform</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-7">buf</span><span class="hl-1"> = </span><span class="hl-7">empty</span><span class="hl-1">;</span><br/><br/><span class="hl-1">  </span><span class="hl-0">constructor</span><span class="hl-1">(</span><span class="hl-7">options</span><span class="hl-1">?: </span><span class="hl-3">TransformOptions</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-0">super</span><span class="hl-1">({</span><br/><span class="hl-1">      ...</span><span class="hl-7">options</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-7">readableObjectMode:</span><span class="hl-1"> </span><span class="hl-0">true</span><span class="hl-1">,</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">  }</span><br/><br/><span class="hl-1">  </span><span class="hl-5">_transform</span><span class="hl-1">(</span><span class="hl-7">chunk</span><span class="hl-1">: </span><span class="hl-3">unknown</span><span class="hl-1">, </span><span class="hl-7">encoding</span><span class="hl-1">: </span><span class="hl-3">BufferEncoding</span><span class="hl-1">, </span><span class="hl-7">callback</span><span class="hl-1">: </span><span class="hl-3">TransformCallback</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-9">if</span><span class="hl-1"> (</span><span class="hl-7">Buffer</span><span class="hl-1">.</span><span class="hl-5">isBuffer</span><span class="hl-1">(</span><span class="hl-7">chunk</span><span class="hl-1">)) {</span><br/><span class="hl-1">      </span><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">data</span><span class="hl-1"> = </span><span class="hl-7">Buffer</span><span class="hl-1">.</span><span class="hl-5">concat</span><span class="hl-1">([</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-7">buf</span><span class="hl-1">, </span><span class="hl-7">chunk</span><span class="hl-1">]);</span><br/><span class="hl-1">      </span><span class="hl-9">if</span><span class="hl-1"> (</span><span class="hl-7">data</span><span class="hl-1">.</span><span class="hl-7">length</span><span class="hl-1"> &gt; </span><span class="hl-4">0</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-7">buf</span><span class="hl-1"> = </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-5">recognize</span><span class="hl-1">(</span><span class="hl-7">data</span><span class="hl-1">);</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><span class="hl-5">callback</span><span class="hl-1">();</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-5">_flush</span><span class="hl-1">(</span><span class="hl-7">callback</span><span class="hl-1">: </span><span class="hl-3">TransformCallback</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-7">buf</span><span class="hl-1"> = </span><span class="hl-7">empty</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-5">callback</span><span class="hl-1">();</span><br/><span class="hl-1">  }</span><br/><br/><span class="hl-1">  </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-5">recognize</span><span class="hl-1">(</span><span class="hl-7">data</span><span class="hl-1">: </span><span class="hl-3">Buffer</span><span class="hl-1">): </span><span class="hl-3">Buffer</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-9">for</span><span class="hl-1"> (</span><span class="hl-0">let</span><span class="hl-1"> </span><span class="hl-7">offset</span><span class="hl-1"> = </span><span class="hl-4">0</span><span class="hl-1">;;) {</span><br/><span class="hl-1">      </span><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">rest</span><span class="hl-1"> = </span><span class="hl-7">data</span><span class="hl-1">.</span><span class="hl-7">length</span><span class="hl-1"> - </span><span class="hl-7">offset</span><span class="hl-1">;</span><br/><span class="hl-1">      </span><span class="hl-9">if</span><span class="hl-1"> (</span><span class="hl-7">rest</span><span class="hl-1"> &lt;= </span><span class="hl-4">0</span><span class="hl-1">) </span><span class="hl-9">return</span><span class="hl-1"> </span><span class="hl-7">empty</span><span class="hl-1">;</span><br/><span class="hl-1">      </span><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">start</span><span class="hl-1"> = </span><span class="hl-7">data</span><span class="hl-1">.</span><span class="hl-5">indexOf</span><span class="hl-1">(</span><span class="hl-7">rest</span><span class="hl-1"> &lt; </span><span class="hl-7">preamble</span><span class="hl-1">.</span><span class="hl-7">length</span><span class="hl-1"> ? </span><span class="hl-7">preamble</span><span class="hl-1">.</span><span class="hl-5">slice</span><span class="hl-1">(</span><span class="hl-4">0</span><span class="hl-1">, </span><span class="hl-7">rest</span><span class="hl-1">) : </span><span class="hl-7">preamble</span><span class="hl-1">, </span><span class="hl-7">offset</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-9">if</span><span class="hl-1"> (</span><span class="hl-7">start</span><span class="hl-1"> === -</span><span class="hl-4">1</span><span class="hl-1">) </span><span class="hl-9">return</span><span class="hl-1"> </span><span class="hl-7">empty</span><span class="hl-1">;</span><br/><span class="hl-1">      </span><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">frame</span><span class="hl-1"> = </span><span class="hl-7">data</span><span class="hl-1">.</span><span class="hl-5">slice</span><span class="hl-1">(</span><span class="hl-7">start</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-9">if</span><span class="hl-1"> (</span><span class="hl-7">frame</span><span class="hl-1">.</span><span class="hl-7">length</span><span class="hl-1"> &lt; </span><span class="hl-7">Package</span><span class="hl-1">.</span><span class="hl-7">baseSize</span><span class="hl-1">) </span><span class="hl-9">return</span><span class="hl-1"> </span><span class="hl-7">frame</span><span class="hl-1">;</span><br/><span class="hl-1">      </span><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">length</span><span class="hl-1"> = </span><span class="hl-7">frame</span><span class="hl-1">.</span><span class="hl-5">readUInt16LE</span><span class="hl-1">(</span><span class="hl-7">lengthOffset</span><span class="hl-1">);</span><br/><span class="hl-1">      </span><span class="hl-9">if</span><span class="hl-1"> (</span><span class="hl-7">length</span><span class="hl-1"> &lt;= </span><span class="hl-2">MAX_LENGTH</span><span class="hl-1">) {</span><br/><br/><span class="hl-1">        </span><span class="hl-8">// calculate the total size of structure</span><br/><span class="hl-1">        </span><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">total</span><span class="hl-1"> = </span><span class="hl-7">length</span><span class="hl-1"> + </span><span class="hl-7">Package</span><span class="hl-1">.</span><span class="hl-7">baseSize</span><span class="hl-1">;</span><br/><span class="hl-1">        </span><span class="hl-9">if</span><span class="hl-1"> (</span><span class="hl-7">frame</span><span class="hl-1">.</span><span class="hl-7">length</span><span class="hl-1"> &lt; </span><span class="hl-7">total</span><span class="hl-1">) </span><span class="hl-9">return</span><span class="hl-1"> </span><span class="hl-7">frame</span><span class="hl-1">;</span><br/><br/><span class="hl-1">        </span><span class="hl-8">// deserialize Package from the buffer</span><br/><span class="hl-1">        </span><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">pkg</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Package</span><span class="hl-1">(</span><span class="hl-7">frame</span><span class="hl-1">.</span><span class="hl-5">slice</span><span class="hl-1">(</span><span class="hl-4">0</span><span class="hl-1">, </span><span class="hl-7">total</span><span class="hl-1">));</span><br/><br/><span class="hl-1">        </span><span class="hl-8">// crc check</span><br/><span class="hl-1">        </span><span class="hl-9">if</span><span class="hl-1"> (</span><span class="hl-7">Package</span><span class="hl-1">.</span><span class="hl-5">crc</span><span class="hl-1">(</span><span class="hl-7">pkg</span><span class="hl-1">) === </span><span class="hl-7">pkg</span><span class="hl-1">.</span><span class="hl-7">crc</span><span class="hl-1">) {</span><br/><br/><span class="hl-1">          </span><span class="hl-8">// push decoded package</span><br/><span class="hl-1">          </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-5">push</span><span class="hl-1">(</span><span class="hl-7">pkg</span><span class="hl-1">);</span><br/><span class="hl-1">          </span><span class="hl-7">offset</span><span class="hl-1"> = </span><span class="hl-7">start</span><span class="hl-1"> + </span><span class="hl-7">total</span><span class="hl-1">;</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">      </span><br/><span class="hl-1">      </span><span class="hl-9">if</span><span class="hl-1"> (</span><span class="hl-7">offset</span><span class="hl-1"> &lt;= </span><span class="hl-7">start</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-7">offset</span><span class="hl-1"> = </span><span class="hl-7">start</span><span class="hl-1"> + </span><span class="hl-4">1</span><span class="hl-1">;</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code></pre>
<p>Encoder.ts</p>
<pre><code class="language-ts"><span class="hl-9">import</span><span class="hl-1"> { </span><span class="hl-7">Transform</span><span class="hl-1">, </span><span class="hl-7">TransformCallback</span><span class="hl-1">, </span><span class="hl-7">TransformOptions</span><span class="hl-1"> } </span><span class="hl-9">from</span><span class="hl-1"> </span><span class="hl-6">&#39;stream&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-9">import</span><span class="hl-1"> { </span><span class="hl-7">Package</span><span class="hl-1"> } </span><span class="hl-9">from</span><span class="hl-1"> </span><span class="hl-6">&#39;./Package&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-9">export</span><span class="hl-1"> </span><span class="hl-9">default</span><span class="hl-1"> </span><span class="hl-0">class</span><span class="hl-1"> </span><span class="hl-3">Encoder</span><span class="hl-1"> </span><span class="hl-0">extends</span><span class="hl-1"> </span><span class="hl-3">Transform</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-0">constructor</span><span class="hl-1">(</span><span class="hl-7">options</span><span class="hl-1">?: </span><span class="hl-3">TransformOptions</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-0">super</span><span class="hl-1">({</span><br/><span class="hl-1">      ...</span><span class="hl-7">options</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-7">writableObjectMode:</span><span class="hl-1"> </span><span class="hl-0">true</span><span class="hl-1">,</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">  }</span><br/><br/><span class="hl-1">  </span><span class="hl-0">public</span><span class="hl-1"> </span><span class="hl-5">_transform</span><span class="hl-1">(</span><span class="hl-7">chunk</span><span class="hl-1">: </span><span class="hl-3">unknown</span><span class="hl-1">, </span><span class="hl-7">encoding</span><span class="hl-1">: </span><span class="hl-3">BufferEncoding</span><span class="hl-1">, </span><span class="hl-7">callback</span><span class="hl-1">: </span><span class="hl-3">TransformCallback</span><span class="hl-1">): </span><span class="hl-3">void</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">chunks</span><span class="hl-1"> = </span><span class="hl-3">Array</span><span class="hl-1">.</span><span class="hl-5">isArray</span><span class="hl-1">(</span><span class="hl-7">chunk</span><span class="hl-1">) ? </span><span class="hl-7">chunk</span><span class="hl-1"> : [</span><span class="hl-7">chunk</span><span class="hl-1">];</span><br/><span class="hl-1">    </span><span class="hl-7">chunks</span><span class="hl-1">.</span><span class="hl-5">forEach</span><span class="hl-1">(</span><span class="hl-7">pkg</span><span class="hl-1"> </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><br/><span class="hl-1">      </span><span class="hl-8">// instance type check</span><br/><span class="hl-1">      </span><span class="hl-9">if</span><span class="hl-1"> (</span><span class="hl-7">pkg</span><span class="hl-1"> </span><span class="hl-0">instanceof</span><span class="hl-1"> </span><span class="hl-3">Package</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><br/><span class="hl-1">        </span><span class="hl-8">// getting a raw buffer</span><br/><span class="hl-1">        </span><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">raw</span><span class="hl-1"> = </span><span class="hl-7">Package</span><span class="hl-1">.</span><span class="hl-5">raw</span><span class="hl-1">(</span><span class="hl-7">pkg</span><span class="hl-1">);</span><br/><br/><span class="hl-1">        </span><span class="hl-8">// update length</span><br/><span class="hl-1">        </span><span class="hl-7">pkg</span><span class="hl-1">.</span><span class="hl-7">length</span><span class="hl-1"> = </span><span class="hl-7">pkg</span><span class="hl-1">.</span><span class="hl-7">data</span><span class="hl-1">.</span><span class="hl-7">length</span><span class="hl-1">;</span><br/><br/><span class="hl-1">        </span><span class="hl-8">// update crc</span><br/><span class="hl-1">        </span><span class="hl-7">Package</span><span class="hl-1">.</span><span class="hl-5">crc</span><span class="hl-1">(</span><span class="hl-7">pkg</span><span class="hl-1">, </span><span class="hl-0">true</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><br/><span class="hl-1">        </span><span class="hl-8">// serialize</span><br/><span class="hl-1">        </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-5">push</span><span class="hl-1">(</span><span class="hl-7">raw</span><span class="hl-1">);</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">    </span><span class="hl-5">callback</span><span class="hl-1">();</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code></pre>
<p>serial.ts</p>
<pre><code class="language-ts"><span class="hl-9">import</span><span class="hl-1"> </span><span class="hl-7">pump</span><span class="hl-1"> </span><span class="hl-9">from</span><span class="hl-1"> </span><span class="hl-6">&#39;pump&#39;</span><span class="hl-1">;</span><br/><span class="hl-9">import</span><span class="hl-1"> </span><span class="hl-7">SerialPort</span><span class="hl-1"> </span><span class="hl-9">from</span><span class="hl-1"> </span><span class="hl-6">&#39;serialport&#39;</span><span class="hl-1">;</span><br/><span class="hl-9">import</span><span class="hl-1"> </span><span class="hl-7">Decoder</span><span class="hl-1"> </span><span class="hl-9">from</span><span class="hl-1"> </span><span class="hl-6">&#39;./Decoder&#39;</span><span class="hl-1">;</span><br/><span class="hl-9">import</span><span class="hl-1"> </span><span class="hl-7">Encoder</span><span class="hl-1"> </span><span class="hl-9">from</span><span class="hl-1"> </span><span class="hl-6">&#39;./Encoder&#39;</span><span class="hl-1">;</span><br/><span class="hl-9">import</span><span class="hl-1"> { </span><span class="hl-7">Package</span><span class="hl-1">, </span><span class="hl-7">Command</span><span class="hl-1"> } </span><span class="hl-9">from</span><span class="hl-1"> </span><span class="hl-6">&#39;./Package&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-8">// ...</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">decoder</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Decoder</span><span class="hl-1">();</span><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">encoder</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Encoder</span><span class="hl-1">();</span><br/><span class="hl-0">let</span><span class="hl-1"> </span><span class="hl-7">connected</span><span class="hl-1"> = </span><span class="hl-0">false</span><span class="hl-1">;</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">serial</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">SerialPort</span><span class="hl-1">(</span><span class="hl-7">path</span><span class="hl-1">, { </span><span class="hl-7">baudRate:</span><span class="hl-1"> </span><span class="hl-4">115200</span><span class="hl-1"> }, </span><span class="hl-7">err</span><span class="hl-1"> </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-9">if</span><span class="hl-1"> (</span><span class="hl-7">err</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-7">console</span><span class="hl-1">.</span><span class="hl-5">error</span><span class="hl-1">(</span><span class="hl-6">`error while open </span><span class="hl-0">${</span><span class="hl-7">path</span><span class="hl-0">}</span><span class="hl-6">`</span><span class="hl-1">)</span><br/><span class="hl-1">  } </span><span class="hl-9">else</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-8">// create a pipeline</span><br/><span class="hl-1">    </span><span class="hl-5">pump</span><span class="hl-1">(</span><span class="hl-7">encoder</span><span class="hl-1">, </span><span class="hl-7">serial</span><span class="hl-1">, </span><span class="hl-7">decoder</span><span class="hl-1">, </span><span class="hl-7">err</span><span class="hl-1"> </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-7">connected</span><span class="hl-1"> = </span><span class="hl-0">false</span><span class="hl-1">;</span><br/><span class="hl-1">      </span><span class="hl-7">console</span><span class="hl-1">.</span><span class="hl-5">log</span><span class="hl-1">(</span><span class="hl-6">&#39;pipe finished&#39;</span><span class="hl-1">, </span><span class="hl-7">err</span><span class="hl-1">);</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">    </span><span class="hl-7">connected</span><span class="hl-1"> = </span><span class="hl-0">true</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-7">decoder</span><span class="hl-1">.</span><span class="hl-5">on</span><span class="hl-1">(</span><span class="hl-6">&#39;data&#39;</span><span class="hl-1">, (</span><span class="hl-7">res</span><span class="hl-1">: </span><span class="hl-3">Package</span><span class="hl-1">) </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-8">// Processing the package</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-8">// Example function for sending data</span><br/><span class="hl-0">async</span><span class="hl-1"> </span><span class="hl-0">function</span><span class="hl-1"> </span><span class="hl-5">send</span><span class="hl-1">(</span><span class="hl-7">data</span><span class="hl-1">: </span><span class="hl-3">Buffer</span><span class="hl-1">, </span><span class="hl-7">src</span><span class="hl-1">: </span><span class="hl-3">number</span><span class="hl-1">, </span><span class="hl-7">dest</span><span class="hl-1">: </span><span class="hl-3">number</span><span class="hl-1">): </span><span class="hl-3">Promise</span><span class="hl-1">&lt;</span><span class="hl-3">void</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">  </span><span class="hl-9">if</span><span class="hl-1"> (!</span><span class="hl-7">connected</span><span class="hl-1">) </span><span class="hl-9">throw</span><span class="hl-1"> </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-3">Error</span><span class="hl-1">(</span><span class="hl-6">&#39;Connection closed&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-8">// Create a packet with the specified buffer size</span><br/><span class="hl-1">  </span><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-2">pkg</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-5">Package</span><span class="hl-1">(</span><span class="hl-7">data</span><span class="hl-1">.</span><span class="hl-7">length</span><span class="hl-1"> + </span><span class="hl-7">Package</span><span class="hl-1">.</span><span class="hl-7">baseSize</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-8">// Package initialization</span><br/><span class="hl-1">  </span><span class="hl-7">data</span><span class="hl-1">.</span><span class="hl-5">copy</span><span class="hl-1">(</span><span class="hl-7">pkg</span><span class="hl-1">.</span><span class="hl-7">data</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-7">pkg</span><span class="hl-1">.</span><span class="hl-7">source</span><span class="hl-1"> = </span><span class="hl-7">src</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-7">pkg</span><span class="hl-1">.</span><span class="hl-7">destination</span><span class="hl-1"> = </span><span class="hl-7">dest</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-7">pkg</span><span class="hl-1">.</span><span class="hl-7">command</span><span class="hl-1"> = </span><span class="hl-7">Command</span><span class="hl-1">.</span><span class="hl-7">Write</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><br/><span class="hl-1">  </span><span class="hl-8">// Sending a package</span><br/><span class="hl-1">  </span><span class="hl-9">if</span><span class="hl-1"> (!</span><span class="hl-7">encoder</span><span class="hl-1">.</span><span class="hl-5">write</span><span class="hl-1">(</span><span class="hl-7">pkg</span><span class="hl-1">)) {</span><br/><span class="hl-1">    </span><span class="hl-9">await</span><span class="hl-1"> </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-3">Promise</span><span class="hl-1">(</span><span class="hl-7">resolve</span><span class="hl-1"> </span><span class="hl-0">=&gt;</span><span class="hl-1"> </span><span class="hl-7">encoder</span><span class="hl-1">.</span><span class="hl-5">once</span><span class="hl-1">(</span><span class="hl-6">&#39;drain&#39;</span><span class="hl-1">, </span><span class="hl-7">resolve</span><span class="hl-1">));</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-5">release</span><span class="hl-1"> = () </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-7">serial</span><span class="hl-1">.</span><span class="hl-7">isOpen</span><span class="hl-1"> &amp;&amp; </span><span class="hl-7">serial</span><span class="hl-1">.</span><span class="hl-5">close</span><span class="hl-1">();</span><br/><span class="hl-1">}</span><br/><span class="hl-7">process</span><span class="hl-1">.</span><span class="hl-5">on</span><span class="hl-1">(</span><span class="hl-6">&#39;SIGINT&#39;</span><span class="hl-1">, </span><span class="hl-7">release</span><span class="hl-1">);</span><br/><span class="hl-7">process</span><span class="hl-1">.</span><span class="hl-5">on</span><span class="hl-1">(</span><span class="hl-6">&#39;SIGTERM&#39;</span><span class="hl-1">, </span><span class="hl-7">release</span><span class="hl-1">);</span>
</code></pre>

<a href="#license" id="license" style="color: inherit; text-decoration: none;">
  <h2>License</h2>
</a>
<p>This project is licensed under the MIT License - see the <a href="LICENSE">LICENSE</a> file for details</p>
</div></div><div class="col-4 col-menu menu-sticky-wrap menu-highlight"><nav class="tsd-navigation primary"><ul><li class="current"><a href="modules.html">Exports</a></li></ul></nav><nav class="tsd-navigation secondary menu-sticky"><ul><li class="tsd-kind-enum"><a href="enums/PropType.html" class="tsd-kind-icon">Prop<wbr/>Type</a></li><li class="tsd-kind-class tsd-has-type-parameter"><a href="classes/Struct.html" class="tsd-kind-icon">Struct</a></li><li class="tsd-kind-interface tsd-has-type-parameter"><a href="interfaces/CRC.html" class="tsd-kind-icon">CRC</a></li><li class="tsd-kind-interface tsd-has-type-parameter"><a href="interfaces/StructConstructor.html" class="tsd-kind-icon">Struct<wbr/>Constructor</a></li><li class="tsd-kind-type-alias"><a href="modules.html#BitMask" class="tsd-kind-icon">Bit<wbr/>Mask</a></li><li class="tsd-kind-type-alias tsd-has-type-parameter"><a href="modules.html#BitMaskN" class="tsd-kind-icon">Bit<wbr/>MaskN</a></li><li class="tsd-kind-type-alias"><a href="modules.html#CRCCalc" class="tsd-kind-icon">CRCCalc</a></li><li class="tsd-kind-type-alias"><a href="modules.html#CRCOpts" class="tsd-kind-icon">CRCOpts</a></li><li class="tsd-kind-type-alias tsd-has-type-parameter"><a href="modules.html#Enumerate" class="tsd-kind-icon">Enumerate</a></li><li class="tsd-kind-type-alias tsd-has-type-parameter"><a href="modules.html#ExtractType" class="tsd-kind-icon">Extract<wbr/>Type</a></li><li class="tsd-kind-type-alias tsd-has-type-parameter"><a href="modules.html#Getter" class="tsd-kind-icon">Getter</a></li><li class="tsd-kind-type-alias tsd-has-type-parameter"><a href="modules.html#Range" class="tsd-kind-icon">Range</a></li><li class="tsd-kind-type-alias tsd-has-type-parameter"><a href="modules.html#Setter" class="tsd-kind-icon">Setter</a></li><li class="tsd-kind-type-alias"><a href="modules.html#StringArrayOpts" class="tsd-kind-icon">String<wbr/>Array<wbr/>Opts</a></li><li class="tsd-kind-type-alias tsd-has-type-parameter"><a href="modules.html#StringOpts" class="tsd-kind-icon">String<wbr/>Opts</a></li><li class="tsd-kind-type-alias tsd-has-type-parameter"><a href="modules.html#WithCRC" class="tsd-kind-icon">WithCRC</a></li><li class="tsd-kind-function"><a href="modules.html#getMask" class="tsd-kind-icon">get<wbr/>Mask</a></li><li class="tsd-kind-function tsd-has-type-parameter"><a href="modules.html#typed" class="tsd-kind-icon">typed</a></li></ul></nav></div></div></div><footer class="with-border-bottom"><div class="container"><h2>Legend</h2><div class="tsd-legend-group"><ul class="tsd-legend"><li class="tsd-kind-constructor tsd-parent-kind-interface"><span class="tsd-kind-icon">Constructor</span></li><li class="tsd-kind-property tsd-parent-kind-interface"><span class="tsd-kind-icon">Property</span></li><li class="tsd-kind-method tsd-parent-kind-interface"><span class="tsd-kind-icon">Method</span></li></ul><ul class="tsd-legend"><li class="tsd-kind-method tsd-parent-kind-class"><span class="tsd-kind-icon">Method</span></li></ul></div><h2>Settings</h2><p>Theme <select id="theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></p></div></footer><div class="container tsd-generator"><p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></div><div class="overlay"></div><script src="assets/main.js"></script></body></html>